module elfe_msgp
#ifdef USE_MPIMODULE
use mpi
#endif
use elfe_glbl, only : rkind, llist_type,nvrt, &
ne_global,ne,neg,nea,ielg,iegl,iegrpv,nm,js, &
np_global,np,npg,npa,iplg,ipgl,nne,ine,dp, &
ns_global,ns,nsg,nsa,islg,isgl,is,isidenode, &
errmsg,fdb,lfdb,nmgb,ic3gb,nnegb,inegb,mntr,ntracers
implicit none
#ifndef USE_MPIMODULE
include 'mpif.h'
#endif
private
integer,public,save :: myrank
integer,public,save :: nproc
integer,public,save :: ierr
integer,public,save :: istatus(MPI_STATUS_SIZE)
integer,public,save :: comm
integer,public,save :: itype = MPI_INTEGER
#ifdef USE_SINGLE
integer,public,save :: rtype = MPI_REAL4
#else
integer,public,save :: rtype = MPI_REAL8
#endif
integer,public,save :: nnbr
integer,public,save,allocatable :: nbrrank(:)
integer,public,save,allocatable :: ranknbr(:)
integer,public,save :: nnbr_p
integer,public,save,allocatable :: nbrrank_p(:)
integer,public,save,allocatable :: ranknbr_p(:)
integer,save :: mnesend
integer,save,allocatable :: nesend(:)
integer,save,allocatable :: iesend(:,:)
integer,save :: mnerecv
integer,save,allocatable :: nerecv(:)
integer,save,allocatable :: ierecv(:,:)
integer,save :: mnpsend
integer,save,allocatable :: npsend(:)
integer,save,allocatable :: ipsend(:,:)
integer,save :: mnprecv
integer,save,allocatable :: nprecv(:)
integer,save,allocatable :: iprecv(:,:)
integer,save :: mnssend
integer,save,allocatable :: nssend(:)
integer,save,allocatable :: issend(:,:)
integer,save :: mnsrecv
integer,save,allocatable :: nsrecv(:)
integer,save,allocatable :: isrecv(:,:)
integer,save,allocatable :: e2dsend_type(:)
integer,save,allocatable :: e2dsend_rqst(:)
integer,save,allocatable :: e2dsend_stat(:,:)
integer,save,allocatable :: e2drecv_type(:)
integer,save,allocatable :: e2drecv_rqst(:)
integer,save,allocatable :: e2drecv_stat(:,:)
integer,save,allocatable :: e2disend_type(:)
integer,save,allocatable :: e2disend_rqst(:)
integer,save,allocatable :: e2disend_stat(:,:)
integer,save,allocatable :: e2direcv_type(:)
integer,save,allocatable :: e2direcv_rqst(:)
integer,save,allocatable :: e2direcv_stat(:,:)
integer,save,allocatable :: e3dwsend_type(:)
integer,save,allocatable :: e3dwsend_rqst(:)
integer,save,allocatable :: e3dwsend_stat(:,:)
integer,save,allocatable :: e3dwrecv_type(:)
integer,save,allocatable :: e3dwrecv_rqst(:)
integer,save,allocatable :: e3dwrecv_stat(:,:)
integer,save,allocatable :: p2dsend_type(:)
integer,save,allocatable :: p2dsend_rqst(:)
integer,save,allocatable :: p2dsend_stat(:,:)
integer,save,allocatable :: p2drecv_type(:)
integer,save,allocatable :: p2drecv_rqst(:)
integer,save,allocatable :: p2drecv_stat(:,:)
integer,save,allocatable :: p3dwsend_type(:)
integer,save,allocatable :: p3dwsend_rqst(:)
integer,save,allocatable :: p3dwsend_stat(:,:)
integer,save,allocatable :: p3dwrecv_type(:)
integer,save,allocatable :: p3dwrecv_rqst(:)
integer,save,allocatable :: p3dwrecv_stat(:,:)
integer,save,allocatable :: p2disend_type(:)
integer,save,allocatable :: p2disend_rqst(:)
integer,save,allocatable :: p2disend_stat(:,:)
integer,save,allocatable :: p2direcv_type(:)
integer,save,allocatable :: p2direcv_rqst(:)
integer,save,allocatable :: p2direcv_stat(:,:)
integer,save,allocatable :: p2d_9_send_type(:)
integer,save,allocatable :: p2d_9_send_rqst(:)
integer,save,allocatable :: p2d_9_send_stat(:,:)
integer,save,allocatable :: p2d_9_recv_type(:)
integer,save,allocatable :: p2d_9_recv_rqst(:)
integer,save,allocatable :: p2d_9_recv_stat(:,:)
integer,save,allocatable :: s2dsend_type(:)
integer,save,allocatable :: s2dsend_rqst(:)
integer,save,allocatable :: s2dsend_stat(:,:)
integer,save,allocatable :: s2drecv_type(:)
integer,save,allocatable :: s2drecv_rqst(:)
integer,save,allocatable :: s2drecv_stat(:,:)
integer,save,allocatable :: s2d_9_send_type(:)
integer,save,allocatable :: s2d_9_send_rqst(:)
integer,save,allocatable :: s2d_9_send_stat(:,:)
integer,save,allocatable :: s2d_9_recv_type(:)
integer,save,allocatable :: s2d_9_recv_rqst(:)
integer,save,allocatable :: s2d_9_recv_stat(:,:)
integer,save,allocatable :: s3dwsend_type(:)
integer,save,allocatable :: s3dwsend_rqst(:)
integer,save,allocatable :: s3dwsend_stat(:,:)
integer,save,allocatable :: s3dwrecv_type(:)
integer,save,allocatable :: s3dwrecv_rqst(:)
integer,save,allocatable :: s3dwrecv_stat(:,:)
integer,save,allocatable :: s2disend_type(:)
integer,save,allocatable :: s2disend_rqst(:)
integer,save,allocatable :: s2disend_stat(:,:)
integer,save,allocatable :: s2direcv_type(:)
integer,save,allocatable :: s2direcv_rqst(:)
integer,save,allocatable :: s2direcv_stat(:,:)
integer,save,allocatable :: s3d_5_send_type(:)
integer,save,allocatable :: s3d_5_send_rqst(:)
integer,save,allocatable :: s3d_5_send_stat(:,:)
integer,save,allocatable :: s3d_5_recv_type(:)
integer,save,allocatable :: s3d_5_recv_rqst(:)
integer,save,allocatable :: s3d_5_recv_stat(:,:)
integer,save,allocatable :: s3d_4_send_type(:)
integer,save,allocatable :: s3d_4_send_rqst(:)
integer,save,allocatable :: s3d_4_send_stat(:,:)
integer,save,allocatable :: s3d_4_recv_type(:)
integer,save,allocatable :: s3d_4_recv_rqst(:)
integer,save,allocatable :: s3d_4_recv_stat(:,:)
integer,save,allocatable :: s3d_2_send_type(:)
integer,save,allocatable :: s3d_2_send_rqst(:)
integer,save,allocatable :: s3d_2_send_stat(:,:)
integer,save,allocatable :: s3d_2_recv_type(:)
integer,save,allocatable :: s3d_2_recv_rqst(:)
integer,save,allocatable :: s3d_2_recv_stat(:,:)
integer,save,allocatable :: s3d_tr2_send_type(:)
integer,save,allocatable :: s3d_tr2_send_rqst(:)
integer,save,allocatable :: s3d_tr2_send_stat(:,:)
integer,save,allocatable :: s3d_tr2_recv_type(:)
integer,save,allocatable :: s3d_tr2_recv_rqst(:)
integer,save,allocatable :: s3d_tr2_recv_stat(:,:)
integer,save,allocatable :: p3d_2_send_type(:)
integer,save,allocatable :: p3d_2_send_rqst(:)
integer,save,allocatable :: p3d_2_send_stat(:,:)
integer,save,allocatable :: p3d_2_recv_type(:)
integer,save,allocatable :: p3d_2_recv_rqst(:)
integer,save,allocatable :: p3d_2_recv_stat(:,:)
integer,save,allocatable :: p3d_3_send_type(:)
integer,save,allocatable :: p3d_3_send_rqst(:)
integer,save,allocatable :: p3d_3_send_stat(:,:)
integer,save,allocatable :: p3d_3_recv_type(:)
integer,save,allocatable :: p3d_3_recv_rqst(:)
integer,save,allocatable :: p3d_3_recv_stat(:,:)
integer,save,allocatable :: p3d_4_send_type(:)
integer,save,allocatable :: p3d_4_send_rqst(:)
integer,save,allocatable :: p3d_4_send_stat(:,:)
integer,save,allocatable :: p3d_4_recv_type(:)
integer,save,allocatable :: p3d_4_recv_rqst(:)
integer,save,allocatable :: p3d_4_recv_stat(:,:)
integer,save,allocatable :: p3d_tr_send_type(:)
integer,save,allocatable :: p3d_tr_send_rqst(:)
integer,save,allocatable :: p3d_tr_send_stat(:,:)
integer,save,allocatable :: p3d_tr_recv_type(:)
integer,save,allocatable :: p3d_tr_recv_rqst(:)
integer,save,allocatable :: p3d_tr_recv_stat(:,:)
integer,save,allocatable :: e3d_2_send_type(:)
integer,save,allocatable :: e3d_2_send_rqst(:)
integer,save,allocatable :: e3d_2_send_stat(:,:)
integer,save,allocatable :: e3d_2_recv_type(:)
integer,save,allocatable :: e3d_2_recv_rqst(:)
integer,save,allocatable :: e3d_2_recv_stat(:,:)
integer,save,allocatable :: e3d_tr_send_type(:)
integer,save,allocatable :: e3d_tr_send_rqst(:)
integer,save,allocatable :: e3d_tr_send_stat(:,:)
integer,save,allocatable :: e3d_tr_recv_type(:)
integer,save,allocatable :: e3d_tr_recv_rqst(:)
integer,save,allocatable :: e3d_tr_recv_stat(:,:)
integer,save,allocatable :: e3d_tr2_send_type(:)
integer,save,allocatable :: e3d_tr2_send_rqst(:)
integer,save,allocatable :: e3d_tr2_send_stat(:,:)
integer,save,allocatable :: e3d_tr2_recv_type(:)
integer,save,allocatable :: e3d_tr2_recv_rqst(:)
integer,save,allocatable :: e3d_tr2_recv_stat(:,:)
public :: parallel_finalize
public :: parallel_abort
public :: parallel_barrier
public :: parallel_rrsync
public :: msgp_tables
public :: msgp_init
public :: exchange_e2d
public :: exchange_e2di
public :: exchange_e3dw
public :: exchange_e3d_2
public :: exchange_e3d_tr
public :: exchange_e3d_tr2
public :: exchange_p2d
public :: exchange_p3dw
public :: exchange_p2di
public :: exchange_p2d_9
public :: exchange_p3d_2
public :: exchange_p3d_3
public :: exchange_p3d_4
public :: exchange_p3d_tr
public :: exchange_s2d
public :: exchange_s2d_9
public :: exchange_s2di
public :: exchange_s3dw
public :: exchange_s3d_5
public :: exchange_s3d_4
public :: exchange_s3d_2
public :: exchange_s3d_tr2
contains
subroutine parallel_finalize
implicit none
call mpi_finalize(ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort(error=ierr)
end subroutine parallel_finalize
subroutine parallel_abort(string,error)
implicit none
character(*),optional,intent(in) :: string
integer,optional,intent(in) :: error
integer :: ierror,i
logical :: lopen
integer :: sl
character(80) :: s
inquire(11,opened=lopen)
if(present(string)) then
write(*,'(i4,2a)') myrank,': ABORT: ',string
if(lopen) write(11,'(i4,2a)') myrank,': ABORT: ',string
endif
if(present(error)) then
if(error/=MPI_SUCCESS) then
call mpi_error_string(error,s,sl,ierror)
write(*,'(i4,2a)') myrank,': MPI ERROR: ',s
if(lopen) write(11,'(i4,2a)') myrank,': MPI ERROR: ',s
endif
do i=1,200; inquire(i,opened=lopen); if(lopen) close(i); enddo;
call mpi_abort(comm,error,ierror)
else
do i=1,200; inquire(i,opened=lopen); if(lopen) close(i); enddo;
call mpi_abort(comm,0,ierror)
endif
end subroutine parallel_abort
subroutine parallel_barrier
implicit none
call mpi_barrier(comm,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort(error=ierr)
end subroutine parallel_barrier
subroutine parallel_rrsync(istep)
implicit none
integer,intent(in) :: istep
integer :: ibgn,idsnd,itsnd,idrcv,itrcv
if(nproc==1) return
if(istep==1) then
if(myrank==0) return
idrcv=myrank-1; itrcv=istep;
call mpi_recv(ibgn,1,itype,idrcv,itrcv,comm,istatus,ierr)
if(ierr/=MPI_SUCCESS) then
write(errmsg,*) 'PARALLEL_RRSYNC: recv start msg: ',idrcv,itrcv
call parallel_abort(errmsg,ierr)
endif
elseif(istep>1) then
if(myrank<nproc-1) then
idsnd=myrank+1; itsnd=istep-1;
else
idsnd=0; itsnd=istep;
endif
call mpi_ssend(1,1,itype,idsnd,itsnd,comm,ierr)
if(ierr/=MPI_SUCCESS) then
write(errmsg,*) 'PARALLEL_RRSYNC: send start msg: ',idsnd,itsnd
call parallel_abort(errmsg,ierr)
endif
if(myrank>0) then
idrcv=myrank-1; itrcv=istep;
else
idrcv=nproc-1; itrcv=istep;
endif
call mpi_recv(ibgn,1,itype,idrcv,itrcv,comm,istatus,ierr)
if(ierr/=MPI_SUCCESS) then
write(errmsg,*) 'PARALLEL_RRSYNC: recv start msg: ',idrcv,itrcv
call parallel_abort(errmsg,ierr)
endif
elseif(istep<0) then
if(myrank<nproc-1) then
idsnd=myrank+1; itsnd=abs(istep);
call mpi_ssend(1,1,itype,idsnd,itsnd,comm,ierr)
if(ierr/=MPI_SUCCESS) then
write(errmsg,*) 'PARALLEL_RRSYNC: send start msg: ',idsnd,itsnd
call parallel_abort(errmsg,ierr)
endif
endif
call parallel_barrier
endif
end subroutine parallel_rrsync
subroutine msgp_tables
implicit none
integer :: i,j,k,l,ie,ip,isd,irank,stat,iegb,itmp
type(llist_type),pointer :: nd,sd
logical,allocatable :: nbr(:),nbr_p(:),nbr_s(:)
integer,allocatable :: iegrecv(:,:),iegsend(:,:)
integer,allocatable :: ipgrecv(:,:),ipgsend(:,:)
integer,allocatable :: isgrecv(:,:),isgsend(:,:)
integer,allocatable :: srqst(:),sstat(:,:)
integer,allocatable :: rrqst(:),rstat(:,:)
if(nproc==1) return
#ifdef DEBUG
fdb='ctbl_0000'
lfdb=len_trim(fdb)
write(fdb(lfdb-3:lfdb),'(i4.4)') myrank
open(10,file='outputs/'//fdb,status='unknown')
#endif
allocate(nbr(0:nproc-1),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: nbr allocation failure')
nbr=.false.
do ie=ne+1,nea
nbr(iegrpv(ielg(ie)))=.true.
enddo
nnbr=0
do irank=0,nproc-1
if(nbr(irank)) nnbr=nnbr+1
enddo
allocate(nbrrank(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: nbrrank allocation failure')
allocate(ranknbr(0:nproc-1),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: ranknbr allocation failure')
nnbr=0
ranknbr=0
do irank=0,nproc-1
if(nbr(irank)) then
nnbr=nnbr+1
nbrrank(nnbr)=irank
ranknbr(irank)=nnbr
endif
enddo
deallocate(nbr)
allocate(nerecv(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: nerecv allocation failure')
nerecv=0
do ie=ne+1,nea
irank=iegrpv(ielg(ie))
do i=1,nnbr; if(irank==nbrrank(i)) exit; enddo;
nerecv(i)=nerecv(i)+1
enddo
mnerecv=0
do i=1,nnbr
mnerecv=max(mnerecv,nerecv(i))
enddo
allocate(ierecv(mnerecv,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: ierecv allocation failure')
allocate(iegrecv(mnerecv,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: iegrecv allocation failure')
nerecv=0
do ie=ne+1,nea
irank=iegrpv(ielg(ie))
do i=1,nnbr; if(irank==nbrrank(i)) exit; enddo;
nerecv(i)=nerecv(i)+1
ierecv(nerecv(i),i)=ie
iegrecv(nerecv(i),i)=ielg(ie)
enddo
#ifdef DEBUG
write(10,'(a,i8)') 'Number of neighbors:',nnbr
write(10,'(a)') '##########################################################'
write(10,'(a)') 'Element Receive Table:'
do i=1,nnbr
write(10,'(a,3i8)') 'nbrindx,rank,nerecv: ',&
ranknbr(nbrrank(i)),nbrrank(i),nerecv(i)
do j=1,nerecv(i)
write(10,'(t1,2i8)') ierecv(j,i),iegrecv(j,i)
enddo
enddo
write(10,'(a)') '##########################################################'
call parallel_barrier
#endif
allocate(rrqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: rrqst allocation failure')
allocate(rstat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: rstat allocation failure')
allocate(srqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: srqst allocation failure')
allocate(sstat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: sstat allocation failure')
allocate(nesend(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: nesend allocation failure')
do i=1,nnbr
call mpi_irecv(nesend(i),1,itype,nbrrank(i),10,comm,rrqst(i),ierr)
if(ierr/=MPI_SUCCESS) &
call parallel_abort('msgp_tables: mpi_irecv tag=10',ierr)
enddo
do i=1,nnbr
call mpi_isend(nerecv(i),1,itype,nbrrank(i),10,comm,srqst(i),ierr)
if(ierr/=MPI_SUCCESS) &
call parallel_abort('msgp_tables: mpi_isend tag=10',ierr)
enddo
call mpi_waitall(nnbr,rrqst,rstat,ierr)
if(ierr/=MPI_SUCCESS) &
call parallel_abort('msgp_tables: mpi_waitall rrqst tag=10',ierr)
call mpi_waitall(nnbr,srqst,sstat,ierr)
if(ierr/=MPI_SUCCESS) &
call parallel_abort('msgp_tables: mpi_waitall srqst tag=10',ierr)
mnesend=0
do i=1,nnbr
mnesend=max(mnesend,nesend(i))
enddo
allocate(iesend(mnesend,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: iesend allocation failure')
allocate(iegsend(mnesend,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: iegsend allocation failure')
do i=1,nnbr
call mpi_irecv(iegsend(1,i),nesend(i),itype,nbrrank(i),11,comm,rrqst(i),ierr)
if(ierr/=MPI_SUCCESS) &
call parallel_abort('msgp_tables: mpi_irecv tag=11',ierr)
enddo
do i=1,nnbr
call mpi_isend(iegrecv(1,i),nerecv(i),itype,nbrrank(i),11,comm,srqst(i),ierr)
if(ierr/=MPI_SUCCESS) &
call parallel_abort('msgp_tables: mpi_isend tag=11',ierr)
enddo
call mpi_waitall(nnbr,rrqst,rstat,ierr)
if(ierr/=MPI_SUCCESS) &
call parallel_abort('msgp_tables: mpi_waitall rrqst tag=11',ierr)
call mpi_waitall(nnbr,srqst,sstat,ierr)
if(ierr/=MPI_SUCCESS) &
call parallel_abort('msgp_tables: mpi_waitall srqst tag=11',ierr)
do i=1,nnbr
do j=1,nesend(i)
if(iegl(iegsend(j,i))%rank/=myrank) call parallel_abort('send element not resident!')
iesend(j,i)=iegl(iegsend(j,i))%id
enddo
enddo
#ifdef DEBUG
write(10,'(a)') 'Element Send Table:'
do i=1,nnbr
write(10,'(a,3i8)') 'nbrindx,rank,nesend: ',&
ranknbr(nbrrank(i)),nbrrank(i),nesend(i)
do j=1,nesend(i)
write(10,'(t1,2i8)') iesend(j,i),iegsend(j,i)
enddo
enddo
write(10,'(a)') '##########################################################'
call parallel_barrier
#endif
deallocate(iegsend)
deallocate(iegrecv)
allocate(nbr_p(0:nproc-1),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: nbr allocation failure')
nbr_p=.false.
do ie=ne+1,nea
iegb=ielg(ie)
nbr_p(iegrpv(iegb))=.true.
do j=1,3
itmp=nmgb(iegb,j)
do l=1,nnegb(itmp)
k=inegb(itmp,l)
if(iegrpv(k)/=myrank) nbr_p(iegrpv(k))=.true.
enddo
enddo
enddo
nnbr_p=0
do irank=0,nproc-1
if(nbr_p(irank)) nnbr_p=nnbr_p+1
enddo
allocate(nbrrank_p(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: nbrrank_p allocation failure')
allocate(ranknbr_p(0:nproc-1),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: ranknbr_p allocation failure')
nnbr_p=0
ranknbr_p=0
do irank=0,nproc-1
if(nbr_p(irank)) then
nnbr_p=nnbr_p+1
nbrrank_p(nnbr_p)=irank
ranknbr_p(irank)=nnbr_p
endif
enddo
deallocate(nbr_p)
allocate(nprecv(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: nprecv allocation failure')
nprecv=0
do ip=np+1,npa
nd=>ipgl(iplg(ip))%next
if(.not.associated(nd)) then
write(errmsg,*) 'comm_table: error1 in ipgl: ',myrank,ip,iplg(ip)
#ifdef DEBUG
close(10)
#endif
call parallel_abort(errmsg)
endif
itmp=nproc
n01: do
if(nd%rank<itmp) itmp=nd%rank
nd=>nd%next
if(.not.associated(nd)) exit
enddo n01
if(itmp==nproc) call parallel_abort('Failed to find a rank')
j=0
do i=1,nnbr_p
if(nbrrank_p(i)==itmp) then
j=i
exit
endif
enddo
if(j==0) call parallel_abort('Failed to find a process')
nprecv(j)=nprecv(j)+1
enddo
do ip=1,np
nd=>ipgl(iplg(ip))%next
if(associated(nd)) then
if(nd%rank<myrank) then
j=0
do i=1,nnbr_p
if(nd%rank==nbrrank_p(i)) then
j=i
exit
endif
enddo
if(j==0) call parallel_abort('Failed to find a process (2)')
nprecv(j)=nprecv(j)+1
endif
endif
enddo
mnprecv=0
do i=1,nnbr_p
mnprecv=max(mnprecv,nprecv(i))
enddo
allocate(iprecv(mnprecv,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: iprecv allocation failure')
allocate(ipgrecv(mnprecv,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: ipgrecv allocation failure')
nprecv=0
do ip=np+1,npa
nd=>ipgl(iplg(ip))%next
itmp=nproc
n02: do
if(nd%rank<itmp) itmp=nd%rank
nd=>nd%next
if(.not.associated(nd)) exit
enddo n02
do i=1,nnbr_p; if(itmp==nbrrank_p(i)) exit; enddo;
nprecv(i)=nprecv(i)+1
iprecv(nprecv(i),i)=ip
ipgrecv(nprecv(i),i)=iplg(ip)
enddo
do ip=1,np
nd=>ipgl(iplg(ip))%next
if(associated(nd)) then
if(nd%rank<myrank) then
j=0
do i=1,nnbr_p
if(nd%rank==nbrrank_p(i)) then
j=i
exit
endif
enddo
if(j==0) call parallel_abort('Failed to find a process (3)')
nprecv(j)=nprecv(j)+1
iprecv(nprecv(j),j)=ip
ipgrecv(nprecv(j),j)=iplg(ip)
endif
endif
enddo
#ifdef DEBUG
write(10,'(a)') 'Node Receive Table:'
do i=1,nnbr_p
write(10,'(a,3i8)') 'nbrindx,rank,nprecv: ',&
ranknbr_p(nbrrank_p(i)),nbrrank_p(i),nprecv(i)
if(nprecv(i)==0) then
write(10,*) 'Zero recv'
endif
do j=1,nprecv(i)
write(10,'(t1,2i8)') iprecv(j,i),ipgrecv(j,i)
enddo
enddo
write(10,'(a)') '##########################################################'
call parallel_barrier
#endif
allocate(npsend(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: npsend allocation failure')
deallocate(rrqst,rstat,srqst,sstat)
allocate(rrqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: rrqst allocation failure (2)')
allocate(rstat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: rstat allocation failure (2)')
allocate(srqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: srqst allocation failure (2)')
allocate(sstat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: sstat allocation failure (2)')
do i=1,nnbr_p
call mpi_irecv(npsend(i),1,itype,nbrrank_p(i),20,comm,rrqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_irecv tag=20',ierr)
enddo
do i=1,nnbr_p
call mpi_isend(nprecv(i),1,itype,nbrrank_p(i),20,comm,srqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_isend tag=20',ierr)
enddo
call mpi_waitall(nnbr_p,rrqst,rstat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_waitall rrqst tag=20',ierr)
call mpi_waitall(nnbr_p,srqst,sstat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_waitall srqst tag=20',ierr)
mnpsend=0
do i=1,nnbr_p
mnpsend=max(mnpsend,npsend(i))
enddo
allocate(ipsend(mnpsend,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: ipsend allocation failure')
allocate(ipgsend(mnpsend,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: ipgsend allocation failure')
do i=1,nnbr_p
if(npsend(i)/=0) then
call mpi_irecv(ipgsend(1,i),npsend(i),itype,nbrrank_p(i),21,comm,rrqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_irecv tag=21',ierr)
else
rrqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nprecv(i)/=0) then
call mpi_isend(ipgrecv(1,i),nprecv(i),itype,nbrrank_p(i),21,comm,srqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_isend tag=21',ierr)
else
srqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,rrqst,rstat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_waitall rrqst tag=21',ierr)
call mpi_waitall(nnbr_p,srqst,sstat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_waitall srqst tag=21',ierr)
do i=1,nnbr_p
do j=1,npsend(i)
if(ipgl(ipgsend(j,i))%rank/=myrank) call parallel_abort('send node not resident!')
ipsend(j,i)=ipgl(ipgsend(j,i))%id
if(ipsend(j,i)>np) call parallel_abort('send node is ghost!')
enddo
enddo
#ifdef DEBUG
write(10,'(a)') 'Node Send Table:'
do i=1,nnbr_p
write(10,'(a,3i8)') 'nbrindx,rank,npsend: ',&
ranknbr_p(nbrrank_p(i)),nbrrank_p(i),npsend(i)
if(npsend(i)==0) then
write(10,*) 'Zero send'
endif
do j=1,npsend(i)
write(10,'(t1,2i8)') ipsend(j,i),ipgsend(j,i)
enddo
enddo
write(10,'(a)') '##########################################################'
call parallel_barrier
do i=1,nnbr_p
do j=1,npsend(i)
itmp=ipgsend(j,i)
do k=1,nnbr_p
do l=1,nprecv(k)
if(itmp==ipgrecv(l,k)) then
write(errmsg,*)'MSGP: address clash:',i,j,k,l,myrank
call parallel_abort(errmsg)
endif
enddo
enddo
enddo
enddo
itmp=0
do i=1,nnbr_p; itmp=itmp+npsend(i); enddo
call mpi_allreduce(itmp,k,1,itype,MPI_SUM,comm,ierr)
itmp=0
do i=1,nnbr_p; itmp=itmp+nprecv(i); enddo
call mpi_allreduce(itmp,l,1,itype,MPI_SUM,comm,ierr)
if(k/=l) call parallel_abort('Mismatch in # of recv and send')
#endif
deallocate(ipgsend)
deallocate(ipgrecv)
allocate(nsrecv(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: nsrecv allocation failure')
nsrecv=0
do isd=ns+1,nsa
sd=>isgl(islg(isd))%next
if(.not.associated(sd)) then
write(errmsg,*) 'comm_table: error1 in isgl: ',myrank,isd,islg(isd)
#ifdef DEBUG
close(10)
#endif
call parallel_abort(errmsg)
endif
itmp=nproc
s01: do
if(sd%rank<itmp) itmp=sd%rank
sd=>sd%next
if(.not.associated(sd)) exit
enddo s01
if(itmp==nproc) call parallel_abort('Failed to find a rank for side')
j=0
do i=1,nnbr_p
if(itmp==nbrrank_p(i)) then
j=i
exit
endif
enddo
if(j==0) call parallel_abort('Failed to find a processor for side (2)')
nsrecv(j)=nsrecv(j)+1
enddo
do isd=1,ns
sd=>isgl(islg(isd))%next
if(associated(sd)) then
if(sd%rank<myrank) then
j=0
do i=1,nnbr_p
if(sd%rank==nbrrank_p(i)) then
j=i; exit
endif
enddo
if(j==0) call parallel_abort('Failed to find a process (4)')
nsrecv(j)=nsrecv(j)+1
endif
endif
enddo
mnsrecv=0
do i=1,nnbr_p
mnsrecv=max(mnsrecv,nsrecv(i))
enddo
allocate(isrecv(mnsrecv,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: isrecv allocation failure')
allocate(isgrecv(mnsrecv,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: isgrecv allocation failure')
nsrecv=0
do isd=ns+1,nsa
sd=>isgl(islg(isd))%next
itmp=nproc
s02: do
if(sd%rank<itmp) itmp=sd%rank
sd=>sd%next
if(.not.associated(sd)) exit
enddo s02
do i=1,nnbr_p; if(itmp==nbrrank_p(i)) exit; enddo;
nsrecv(i)=nsrecv(i)+1
isrecv(nsrecv(i),i)=isd
isgrecv(nsrecv(i),i)=islg(isd)
enddo
do isd=1,ns
sd=>isgl(islg(isd))%next
if(associated(sd)) then
if(sd%rank<myrank) then
j=0
do i=1,nnbr_p
if(sd%rank==nbrrank_p(i)) then
j=i; exit
endif
enddo
if(j==0) call parallel_abort('Failed to find a process (5)')
nsrecv(j)=nsrecv(j)+1
isrecv(nsrecv(j),j)=isd
isgrecv(nsrecv(j),j)=islg(isd)
endif
endif
enddo
#ifdef DEBUG
write(10,'(a)') 'Side Receive Table:'
do i=1,nnbr_p
write(10,'(a,3i8)') 'nbrindx,rank,nsrecv: ',&
ranknbr_p(nbrrank_p(i)),nbrrank_p(i),nsrecv(i)
if(nsrecv(i)==0) then
write(10,*)'Zero recv side'
endif
do j=1,nsrecv(i)
write(10,'(t1,4i8)') isrecv(j,i),isgrecv(j,i),iplg(isidenode(isrecv(j,i),1:2))
enddo
enddo
write(10,'(a)') '##########################################################'
call parallel_barrier
#endif
allocate(nssend(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: nssend allocation failure')
do i=1,nnbr_p
call mpi_irecv(nssend(i),1,itype,nbrrank_p(i),30,comm,rrqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_irecv tag=30',ierr)
enddo
do i=1,nnbr_p
call mpi_isend(nsrecv(i),1,itype,nbrrank_p(i),30,comm,srqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_isend tag=30',ierr)
enddo
call mpi_waitall(nnbr_p,rrqst,rstat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_waitall rrqst tag=30',ierr)
call mpi_waitall(nnbr_p,srqst,sstat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_waitall srqst tag=30',ierr)
mnssend=0
do i=1,nnbr_p
mnssend=max(mnssend,nssend(i))
enddo
allocate(issend(mnssend,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: issend allocation failure')
allocate(isgsend(mnssend,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_tables: isgsend allocation failure')
do i=1,nnbr_p
if(nssend(i)/=0) then
call mpi_irecv(isgsend(1,i),nssend(i),itype,nbrrank_p(i),31,comm,rrqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_irecv tag=31',ierr)
else
rrqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nsrecv(i)/=0) then
call mpi_isend(isgrecv(1,i),nsrecv(i),itype,nbrrank_p(i),31,comm,srqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_isend tag=31',ierr)
else
srqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,rrqst,rstat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_waitall rrqst tag=31',ierr)
call mpi_waitall(nnbr_p,srqst,sstat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_tables: mpi_waitall srqst tag=31',ierr)
do i=1,nnbr_p
do j=1,nssend(i)
if(isgl(isgsend(j,i))%rank/=myrank) call parallel_abort('Send side not resident')
issend(j,i)=isgl(isgsend(j,i))%id
if(issend(j,i)>ns) call parallel_abort('Send side is ghost')
enddo
enddo
#ifdef DEBUG
write(10,'(a)') 'Side Send Table:'
do i=1,nnbr_p
write(10,'(a,3i8)') 'nbrindx,rank,nssend: ',&
ranknbr_p(nbrrank_p(i)),nbrrank_p(i),nssend(i)
if(nssend(i)==0) then
write(10,*)'Zero send side'
endif
do j=1,nssend(i)
write(10,'(t1,4i8)') issend(j,i),isgsend(j,i),iplg(isidenode(issend(j,i),1:2))
enddo
enddo
write(10,'(a)') '##########################################################'
call parallel_barrier
do i=1,nnbr_p
do j=1,nssend(i)
itmp=isgsend(j,i)
do k=1,nnbr_p
do l=1,nsrecv(k)
if(itmp==isgrecv(l,k)) then
write(errmsg,*)'MSGP: address clash (2):',i,j,k,l,myrank
call parallel_abort(errmsg)
endif
enddo
enddo
enddo
enddo
#endif
deallocate(isgsend)
deallocate(isgrecv)
deallocate(srqst,sstat)
deallocate(rrqst,rstat)
#ifdef DEBUG
close(10)
#endif
end subroutine msgp_tables
subroutine msgp_init
implicit none
integer :: i,stat,maxmax
integer,allocatable :: blen_send(:),dspl_send(:),blen_recv(:),dspl_recv(:)
if(nproc==1) return
maxmax=max(mnesend,mnerecv,mnpsend,mnprecv,mnssend,mnsrecv)
allocate(blen_send(maxmax), blen_recv(maxmax), dspl_send(maxmax), dspl_recv(maxmax),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: dspl allocation failure')
allocate(e2dsend_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2dsend_rqst allocation failure')
allocate(e2dsend_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2dsend_stat allocation failure')
allocate(e2drecv_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2drecv_rqst allocation failure')
allocate(e2drecv_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2drecv_stat allocation failure')
allocate(e2dsend_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2dsend_type allocation failure')
allocate(e2drecv_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2drecv_type allocation failure')
do i=1,nnbr
blen_send(:)=1
dspl_send(1:mnesend)=iesend(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nesend(i),blen_send,dspl_send,rtype,e2dsend_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nesend(i),1,dspl_send,rtype,e2dsend_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e2dsend_type',ierr)
call mpi_type_commit(e2dsend_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e2dsend_type',ierr)
blen_recv(:)=1
dspl_recv(1:mnerecv)=ierecv(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nerecv(i),blen_recv,dspl_recv,rtype,e2drecv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nerecv(i),1,dspl_recv,rtype,e2drecv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e2drecv_type',ierr)
call mpi_type_commit(e2drecv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e2drecv_type',ierr)
enddo
allocate(e2disend_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2disend_rqst allocation failure')
allocate(e2disend_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2disend_stat allocation failure')
allocate(e2direcv_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2direcv_rqst allocation failure')
allocate(e2direcv_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2direcv_stat allocation failure')
allocate(e2disend_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2disend_type allocation failure')
allocate(e2direcv_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e2direcv_type allocation failure')
do i=1,nnbr
blen_send(:)=1
dspl_send(1:mnesend)=iesend(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nesend(i),blen_send,dspl_send,itype,e2disend_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nesend(i),1,dspl_send,itype,e2disend_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e2disend_type',ierr)
call mpi_type_commit(e2disend_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e2disend_type',ierr)
blen_recv(:)=1
dspl_recv(1:mnerecv)=ierecv(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nerecv(i),blen_recv,dspl_recv,itype,e2direcv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nerecv(i),1,dspl_recv,itype,e2direcv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e2direcv_type',ierr)
call mpi_type_commit(e2direcv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e2direcv_type',ierr)
enddo
allocate(e3dwsend_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3dwsend_rqst allocation failure')
allocate(e3dwsend_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3dwsend_stat allocation failure')
allocate(e3dwrecv_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3dwrecv_rqst allocation failure')
allocate(e3dwrecv_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3dwrecv_stat allocation failure')
allocate(e3dwsend_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3dwsend_type allocation failure')
allocate(e3dwrecv_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3dwrecv_type allocation failure')
do i=1,nnbr
blen_send(:)=nvrt
dspl_send(1:mnesend)=(iesend(:,i)-1)*nvrt
#if MPIVERSION==1
call mpi_type_indexed(nesend(i),blen_send,dspl_send,rtype,e3dwsend_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nesend(i),nvrt,dspl_send,rtype,e3dwsend_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e3dw e3dwsend_type',ierr)
call mpi_type_commit(e3dwsend_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e3dwsend_type',ierr)
blen_recv(:)=nvrt
dspl_recv(1:mnerecv)=(ierecv(:,i)-1)*nvrt
#if MPIVERSION==1
call mpi_type_indexed(nerecv(i),blen_recv,dspl_recv,rtype,e3dwrecv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nerecv(i),nvrt,dspl_recv,rtype,e3dwrecv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e3dw e3dwrecv_type',ierr)
call mpi_type_commit(e3dwrecv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e3dwrecv_type',ierr)
enddo
allocate(p2dsend_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2dsend_rqst allocation failure')
allocate(p2dsend_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2dsend_stat allocation failure')
allocate(p2drecv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2drecv_rqst allocation failure')
allocate(p2drecv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2drecv_stat allocation failure')
allocate(p2dsend_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2dsend_type allocation failure')
allocate(p2drecv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2drecv_type allocation failure')
do i=1,nnbr_p
if(npsend(i)/=0) then
blen_send(:)=1
dspl_send(1:mnpsend)=ipsend(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(npsend(i),blen_send,dspl_send,rtype,p2dsend_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(npsend(i),1,dspl_send,rtype,p2dsend_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p2dsend_type',ierr)
call mpi_type_commit(p2dsend_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p2dsend_type',ierr)
endif
if(nprecv(i)/=0) then
blen_recv(:)=1
dspl_recv(1:mnprecv)=iprecv(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nprecv(i),blen_recv,dspl_recv,rtype,p2drecv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nprecv(i),1,dspl_recv,rtype,p2drecv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p2drecv_type',ierr)
call mpi_type_commit(p2drecv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p2drecv_type',ierr)
endif
enddo
allocate(p2disend_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2disend_rqst allocation failure')
allocate(p2disend_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2disend_stat allocation failure')
allocate(p2direcv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2direcv_rqst allocation failure')
allocate(p2direcv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2direcv_stat allocation failure')
allocate(p2disend_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2disend_type allocation failure')
allocate(p2direcv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2direcv_type allocation failure')
do i=1,nnbr_p
if(npsend(i)/=0) then
blen_send(:)=1
dspl_send(1:mnpsend)=ipsend(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(npsend(i),blen_send,dspl_send,itype,p2disend_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(npsend(i),1,dspl_send,itype,p2disend_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p2disend_type',ierr)
call mpi_type_commit(p2disend_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p2disend_type',ierr)
endif
if(nprecv(i)/=0) then
blen_recv(:)=1
dspl_recv(1:mnprecv)=iprecv(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nprecv(i),blen_recv,dspl_recv,itype,p2direcv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nprecv(i),1,dspl_recv,itype,p2direcv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p2direcv_type',ierr)
call mpi_type_commit(p2direcv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p2direcv_type',ierr)
endif
enddo
allocate(p2d_9_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2d_9_send_rqst allocation failure')
allocate(p2d_9_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2d_9_send_stat allocation failure')
allocate(p2d_9_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2d_9_recv_rqst allocation failure')
allocate(p2d_9_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2d_9_recv_stat allocation failure')
allocate(p2d_9_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2d_9_send_type allocation failure')
allocate(p2d_9_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p2d_9_drecv_type allocation failure')
do i=1,nnbr_p
if(npsend(i)/=0) then
blen_send(:)=9
dspl_send(1:mnpsend)=(ipsend(:,i)-1)*9
#if MPIVERSION==1
call mpi_type_indexed(npsend(i),blen_send,dspl_send,rtype,p2d_9_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(npsend(i),9,dspl_send,rtype,p2d_9_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p2d_9_send_type',ierr)
call mpi_type_commit(p2d_9_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p2d_9_send_type',ierr)
endif
if(nprecv(i)/=0) then
blen_recv(:)=9
dspl_recv(1:mnprecv)=(iprecv(:,i)-1)*9
#if MPIVERSION==1
call mpi_type_indexed(nprecv(i),blen_recv,dspl_recv,rtype,p2d_9_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nprecv(i),9,dspl_recv,rtype,p2d_9_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p2d_9_recv_type',ierr)
call mpi_type_commit(p2d_9_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p2d_9_recv_type',ierr)
endif
enddo
allocate(p3dwsend_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3dwsend_rqst allocation failure')
allocate(p3dwsend_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3dwsend_stat allocation failure')
allocate(p3dwrecv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3dwrecv_rqst allocation failure')
allocate(p3dwrecv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3dwrecv_stat allocation failure')
allocate(p3dwsend_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3dwsend_type allocation failure')
allocate(p3dwrecv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3dwrecv_type allocation failure')
do i=1,nnbr_p
if(npsend(i)/=0) then
blen_send(:)=nvrt
dspl_send(1:mnpsend)=(ipsend(:,i)-1)*nvrt
#if MPIVERSION==1
call mpi_type_indexed(npsend(i),blen_send,dspl_send,rtype,p3dwsend_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(npsend(i),nvrt,dspl_send,rtype,p3dwsend_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3dw p3dwsend_type',ierr)
call mpi_type_commit(p3dwsend_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3dwsend_type',ierr)
endif
if(nprecv(i)/=0) then
blen_recv(:)=nvrt
dspl_recv(1:mnprecv)=(iprecv(:,i)-1)*nvrt
#if MPIVERSION==1
call mpi_type_indexed(nprecv(i),blen_recv,dspl_recv,rtype,p3dwrecv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nprecv(i),nvrt,dspl_recv,rtype,p3dwrecv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3dw p3dwrecv_type',ierr)
call mpi_type_commit(p3dwrecv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3dwrecv_type',ierr)
endif
enddo
allocate(s2dsend_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2dsend_rqst allocation failure')
allocate(s2dsend_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2dsend_stat allocation failure')
allocate(s2drecv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2drecv_rqst allocation failure')
allocate(s2drecv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2drecv_stat allocation failure')
allocate(s2dsend_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2dsend_type allocation failure')
allocate(s2drecv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2drecv_type allocation failure')
do i=1,nnbr_p
if(nssend(i)/=0) then
blen_send(:)=1
dspl_send(1:mnssend)=issend(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nssend(i),blen_send,dspl_send,rtype,s2dsend_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nssend(i),1,dspl_send,rtype,s2dsend_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s2dsend_type',ierr)
call mpi_type_commit(s2dsend_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s2dsend_type',ierr)
endif
if(nsrecv(i)/=0) then
blen_recv(:)=1
dspl_recv(1:mnsrecv)=isrecv(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nsrecv(i),blen_recv,dspl_recv,rtype,s2drecv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nsrecv(i),1,dspl_recv,rtype,s2drecv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s2drecv_type',ierr)
call mpi_type_commit(s2drecv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s2drecv_type',ierr)
endif
enddo
allocate(s2d_9_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2d_9_send_rqst allocation failure')
allocate(s2d_9_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2d_9_send_stat allocation failure')
allocate(s2d_9_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2d_9_recv_rqst allocation failure')
allocate(s2d_9_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2d_9_recv_stat allocation failure')
allocate(s2d_9_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2d_9_send_type allocation failure')
allocate(s2d_9_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2d_9_recv_type allocation failure')
do i=1,nnbr_p
if(nssend(i)/=0) then
blen_send(:)=9
dspl_send(1:mnssend)=(issend(:,i)-1)*9
#if MPIVERSION==1
call mpi_type_indexed(nssend(i),blen_send,dspl_send,rtype,s2d_9_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nssend(i),9,dspl_send,rtype,s2d_9_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s2d_9_send_type',ierr)
call mpi_type_commit(s2d_9_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s2d_9_send_type',ierr)
endif
if(nsrecv(i)/=0) then
blen_recv(:)=9
dspl_recv(1:mnsrecv)=(isrecv(:,i)-1)*9
#if MPIVERSION==1
call mpi_type_indexed(nsrecv(i),blen_recv,dspl_recv,rtype,s2d_9_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nsrecv(i),9,dspl_recv,rtype,s2d_9_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s2d_9_recv_type',ierr)
call mpi_type_commit(s2d_9_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s2d_9_recv_type',ierr)
endif
enddo
allocate(s2disend_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2disend_rqst allocation failure')
allocate(s2disend_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2disend_stat allocation failure')
allocate(s2direcv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2direcv_rqst allocation failure')
allocate(s2direcv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2direcv_stat allocation failure')
allocate(s2disend_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2disend_type allocation failure')
allocate(s2direcv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s2direcv_type allocation failure')
do i=1,nnbr_p
if(nssend(i)/=0) then
blen_send(:)=1
dspl_send(1:mnssend)=issend(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nssend(i),blen_send,dspl_send,itype,s2disend_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nssend(i),1,dspl_send,itype,s2disend_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s2disend_type',ierr)
call mpi_type_commit(s2disend_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s2disend_type',ierr)
endif
if(nsrecv(i)/=0) then
blen_recv(:)=1
dspl_recv(1:mnsrecv)=isrecv(:,i)-1
#if MPIVERSION==1
call mpi_type_indexed(nsrecv(i),blen_recv,dspl_recv,itype,s2direcv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nsrecv(i),1,dspl_recv,itype,s2direcv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s2direcv_type',ierr)
call mpi_type_commit(s2direcv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s2direcv_type',ierr)
endif
enddo
allocate(s3dwsend_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3dwsend_rqst allocation failure')
allocate(s3dwsend_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3dwsend_stat allocation failure')
allocate(s3dwrecv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3dwrecv_rqst allocation failure')
allocate(s3dwrecv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3dwrecv_stat allocation failure')
allocate(s3dwsend_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3dwsend_type allocation failure')
allocate(s3dwrecv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3dwrecv_type allocation failure')
do i=1,nnbr_p
if(nssend(i)/=0) then
blen_send(:)=nvrt
dspl_send(1:mnssend)=(issend(:,i)-1)*nvrt
#if MPIVERSION==1
call mpi_type_indexed(nssend(i),blen_send,dspl_send,rtype,s3dwsend_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nssend(i),nvrt,dspl_send,rtype,s3dwsend_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3dw s3dwsend_type',ierr)
call mpi_type_commit(s3dwsend_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3dwsend_type',ierr)
endif
if(nsrecv(i)/=0) then
blen_recv(:)=nvrt
dspl_recv(1:mnsrecv)=(isrecv(:,i)-1)*nvrt
#if MPIVERSION==1
call mpi_type_indexed(nsrecv(i),blen_recv,dspl_recv,rtype,s3dwrecv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nsrecv(i),nvrt,dspl_recv,rtype,s3dwrecv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3dw s3dwrecv_type',ierr)
call mpi_type_commit(s3dwrecv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3dwrecv_type',ierr)
endif
enddo
allocate(s3d_5_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_5_send_rqst allocation failure')
allocate(s3d_5_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_5_send_stat allocation failure')
allocate(s3d_5_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_5_recv_rqst allocation failure')
allocate(s3d_5_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_5_recv_stat allocation failure')
allocate(s3d_5_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_5_send_type allocation failure')
allocate(s3d_5_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_5_recv_type allocation failure')
do i=1,nnbr_p
if(nssend(i)/=0) then
blen_send(:)=nvrt*5
dspl_send(1:mnssend)=(issend(:,i)-1)*nvrt*5
#if MPIVERSION==1
call mpi_type_indexed(nssend(i),blen_send,dspl_send,rtype,s3d_5_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nssend(i),nvrt*5,dspl_send,rtype,s3d_5_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3d_5_send_type',ierr)
call mpi_type_commit(s3d_5_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3d_5_send_type',ierr)
endif
if(nsrecv(i)/=0) then
blen_recv(:)=nvrt*5
dspl_recv(1:mnsrecv)=(isrecv(:,i)-1)*nvrt*5
#if MPIVERSION==1
call mpi_type_indexed(nsrecv(i),blen_recv,dspl_recv,rtype,s3d_5_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nsrecv(i),nvrt*5,dspl_recv,rtype,s3d_5_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3d_5_recv_type',ierr)
call mpi_type_commit(s3d_5_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3d_5_recv_type',ierr)
endif
enddo
allocate(s3d_4_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_4_send_rqst allocation failure')
allocate(s3d_4_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_4_send_stat allocation failure')
allocate(s3d_4_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_4_recv_rqst allocation failure')
allocate(s3d_4_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_4_recv_stat allocation failure')
allocate(s3d_4_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_4_send_type allocation failure')
allocate(s3d_4_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_4_recv_type allocation failure')
do i=1,nnbr_p
if(nssend(i)/=0) then
blen_send(:)=nvrt*4
dspl_send(1:mnssend)=(issend(:,i)-1)*nvrt*4
#if MPIVERSION==1
call mpi_type_indexed(nssend(i),blen_send,dspl_send,rtype,s3d_4_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nssend(i),nvrt*4,dspl_send,rtype,s3d_4_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3d_4_send_type',ierr)
call mpi_type_commit(s3d_4_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3d_4_send_type',ierr)
endif
if(nsrecv(i)/=0) then
blen_recv(:)=nvrt*4
dspl_recv(1:mnsrecv)=(isrecv(:,i)-1)*nvrt*4
#if MPIVERSION==1
call mpi_type_indexed(nsrecv(i),blen_recv,dspl_recv,rtype,s3d_4_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nsrecv(i),nvrt*4,dspl_recv,rtype,s3d_4_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3d_4_recv_type',ierr)
call mpi_type_commit(s3d_4_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3d_4_recv_type',ierr)
endif
enddo
allocate(s3d_2_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_2_send_rqst allocation failure')
allocate(s3d_2_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_2_send_stat allocation failure')
allocate(s3d_2_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_2_recv_rqst allocation failure')
allocate(s3d_2_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_2_recv_stat allocation failure')
allocate(s3d_2_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_2_send_type allocation failure')
allocate(s3d_2_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_2_recv_type allocation failure')
do i=1,nnbr_p
if(nssend(i)/=0) then
blen_send(:)=nvrt*2
dspl_send(1:mnssend)=(issend(:,i)-1)*nvrt*2
#if MPIVERSION==1
call mpi_type_indexed(nssend(i),blen_send,dspl_send,rtype,s3d_2_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nssend(i),nvrt*2,dspl_send,rtype,s3d_2_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3d_2_send_type',ierr)
call mpi_type_commit(s3d_2_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3d_2_send_type',ierr)
endif
if(nsrecv(i)/=0) then
blen_recv(:)=nvrt*2
dspl_recv(1:mnsrecv)=(isrecv(:,i)-1)*nvrt*2
#if MPIVERSION==1
call mpi_type_indexed(nsrecv(i),blen_recv,dspl_recv,rtype,s3d_2_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nsrecv(i),nvrt*2,dspl_recv,rtype,s3d_2_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3d_2_recv_type',ierr)
call mpi_type_commit(s3d_2_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3d_2_recv_type',ierr)
endif
enddo
if(ntracers>0) then
allocate(s3d_tr2_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_tr2_send_rqst allocation failure')
allocate(s3d_tr2_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_tr2_send_stat allocation failure')
allocate(s3d_tr2_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_tr2_recv_rqst allocation failure')
allocate(s3d_tr2_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_tr2_recv_stat allocation failure')
allocate(s3d_tr2_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_tr2_send_type allocation failure')
allocate(s3d_tr2_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: s3d_tr2_recv_type allocation failure')
do i=1,nnbr_p
if(nssend(i)/=0) then
blen_send(:)=nvrt*ntracers
dspl_send(1:mnssend)=(issend(:,i)-1)*nvrt*ntracers
#if MPIVERSION==1
call mpi_type_indexed(nssend(i),blen_send,dspl_send,rtype,s3d_tr2_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nssend(i),nvrt*ntracers,dspl_send,rtype,s3d_tr2_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3d_tr2_send_type',ierr)
call mpi_type_commit(s3d_tr2_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3d_tr2_send_type',ierr)
endif
if(nsrecv(i)/=0) then
blen_recv(:)=nvrt*ntracers
dspl_recv(1:mnsrecv)=(isrecv(:,i)-1)*nvrt*ntracers
#if MPIVERSION==1
call mpi_type_indexed(nsrecv(i),blen_recv,dspl_recv,rtype,s3d_tr2_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nsrecv(i),nvrt*ntracers,dspl_recv,rtype,s3d_tr2_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create s3d_tr2_recv_type',ierr)
call mpi_type_commit(s3d_tr2_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit s3d_tr2_recv_type',ierr)
endif
enddo
endif
allocate(p3d_2_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_2_send_rqst allocation failure')
allocate(p3d_2_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_2_send_stat allocation failure')
allocate(p3d_2_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_2_recv_rqst allocation failure')
allocate(p3d_2_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_2_recv_stat allocation failure')
allocate(p3d_2_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_2_send_type allocation failure')
allocate(p3d_2_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_2_recv_type allocation failure')
do i=1,nnbr_p
if(npsend(i)/=0) then
blen_send(:)=nvrt*2
dspl_send(1:mnpsend)=(ipsend(:,i)-1)*nvrt*2
#if MPIVERSION==1
call mpi_type_indexed(npsend(i),blen_send,dspl_send,rtype,p3d_2_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(npsend(i),nvrt*2,dspl_send,rtype,p3d_2_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3d_2_send_type',ierr)
call mpi_type_commit(p3d_2_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3d_2_send_type',ierr)
endif
if(nprecv(i)/=0) then
blen_recv(:)=nvrt*2
dspl_recv(1:mnprecv)=(iprecv(:,i)-1)*nvrt*2
#if MPIVERSION==1
call mpi_type_indexed(nprecv(i),blen_recv,dspl_recv,rtype,p3d_2_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nprecv(i),nvrt*2,dspl_recv,rtype,p3d_2_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3d_2_recv_type',ierr)
call mpi_type_commit(p3d_2_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3d_2_recv_type',ierr)
endif
enddo
allocate(p3d_3_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_3_send_rqst allocation failure')
allocate(p3d_3_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_3_send_stat allocation failure')
allocate(p3d_3_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_3_recv_rqst allocation failure')
allocate(p3d_3_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_3_recv_stat allocation failure')
allocate(p3d_3_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_3_send_type allocation failure')
allocate(p3d_3_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_3_recv_type allocation failure')
do i=1,nnbr_p
if(npsend(i)/=0) then
blen_send(:)=nvrt*3
dspl_send(1:mnpsend)=(ipsend(:,i)-1)*nvrt*3
#if MPIVERSION==1
call mpi_type_indexed(npsend(i),blen_send,dspl_send,rtype,p3d_3_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(npsend(i),nvrt*3,dspl_send,rtype,p3d_3_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3d_3_send_type',ierr)
call mpi_type_commit(p3d_3_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3d_3_send_type',ierr)
endif
if(nprecv(i)/=0) then
blen_recv(:)=nvrt*3
dspl_recv(1:mnprecv)=(iprecv(:,i)-1)*nvrt*3
#if MPIVERSION==1
call mpi_type_indexed(nprecv(i),blen_recv,dspl_recv,rtype,p3d_3_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nprecv(i),nvrt*3,dspl_recv,rtype,p3d_3_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3d_3_recv_type',ierr)
call mpi_type_commit(p3d_3_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3d_3_recv_type',ierr)
endif
enddo
allocate(p3d_4_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_4_send_rqst allocation failure')
allocate(p3d_4_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_4_send_stat allocation failure')
allocate(p3d_4_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_4_recv_rqst allocation failure')
allocate(p3d_4_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_4_recv_stat allocation failure')
allocate(p3d_4_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_4_send_type allocation failure')
allocate(p3d_4_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_4_recv_type allocation failure')
do i=1,nnbr_p
if(npsend(i)/=0) then
blen_send(:)=nvrt*4
dspl_send(1:mnpsend)=(ipsend(:,i)-1)*nvrt*4
#if MPIVERSION==1
call mpi_type_indexed(npsend(i),blen_send,dspl_send,rtype,p3d_4_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(npsend(i),nvrt*4,dspl_send,rtype,p3d_4_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3d_4_send_type',ierr)
call mpi_type_commit(p3d_4_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3d_4_send_type',ierr)
endif
if(nprecv(i)/=0) then
blen_recv(:)=nvrt*4
dspl_recv(1:mnprecv)=(iprecv(:,i)-1)*nvrt*4
#if MPIVERSION==1
call mpi_type_indexed(nprecv(i),blen_recv,dspl_recv,rtype,p3d_4_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nprecv(i),nvrt*4,dspl_recv,rtype,p3d_4_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3d_4_recv_type',ierr)
call mpi_type_commit(p3d_4_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3d_4_recv_type',ierr)
endif
enddo
if(ntracers>0) then
allocate(p3d_tr_send_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_tr_send_rqst allocation failure')
allocate(p3d_tr_send_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_tr_send_stat allocation failure')
allocate(p3d_tr_recv_rqst(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_tr_recv_rqst allocation failure')
allocate(p3d_tr_recv_stat(MPI_STATUS_SIZE,nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_tr_recv_stat allocation failure')
allocate(p3d_tr_send_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_tr_send_type allocation failure')
allocate(p3d_tr_recv_type(nnbr_p),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: p3d_tr_recv_type allocation failure')
do i=1,nnbr_p
if(npsend(i)/=0) then
blen_send(:)=nvrt*ntracers
dspl_send(1:mnpsend)=(ipsend(:,i)-1)*nvrt*ntracers
#if MPIVERSION==1
call mpi_type_indexed(npsend(i),blen_send,dspl_send,rtype,p3d_tr_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(npsend(i),nvrt*ntracers,dspl_send,rtype,p3d_tr_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3d_tr_send_type',ierr)
call mpi_type_commit(p3d_tr_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3d_tr_send_type',ierr)
endif
if(nprecv(i)/=0) then
blen_recv(:)=nvrt*ntracers
dspl_recv(1:mnprecv)=(iprecv(:,i)-1)*nvrt*ntracers
#if MPIVERSION==1
call mpi_type_indexed(nprecv(i),blen_recv,dspl_recv,rtype,p3d_tr_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nprecv(i),nvrt*ntracers,dspl_recv,rtype,p3d_tr_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create p3d_tr_recv_type',ierr)
call mpi_type_commit(p3d_tr_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit p3d_tr_recv_type',ierr)
endif
enddo
endif
allocate(e3d_tr_send_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr_send_rqst allocation failure')
allocate(e3d_tr_send_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr_send_stat allocation failure')
allocate(e3d_tr_recv_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr_recv_rqst allocation failure')
allocate(e3d_tr_recv_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr_recv_stat allocation failure')
allocate(e3d_tr_send_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr_send_type allocation failure')
allocate(e3d_tr_recv_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr_recv_type allocation failure')
do i=1,nnbr
blen_send(:)=nvrt*mntr
dspl_send(1:mnesend)=(iesend(:,i)-1)*nvrt*mntr
#if MPIVERSION==1
call mpi_type_indexed(nesend(i),blen_send,dspl_send,rtype,e3d_tr_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nesend(i),nvrt*mntr,dspl_send,rtype,e3d_tr_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e3d_tr_send_type',ierr)
call mpi_type_commit(e3d_tr_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e3d_tr_send_type',ierr)
blen_recv(:)=nvrt*mntr
dspl_recv(1:mnerecv)=(ierecv(:,i)-1)*nvrt*mntr
#if MPIVERSION==1
call mpi_type_indexed(nerecv(i),blen_recv,dspl_recv,rtype,e3d_tr_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nerecv(i),nvrt*mntr,dspl_recv,rtype,e3d_tr_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e3d_tr_recv_type',ierr)
call mpi_type_commit(e3d_tr_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e3d_tr_recv_type',ierr)
enddo
allocate(e3d_tr2_send_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr2_send_rqst allocation failure')
allocate(e3d_tr2_send_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr2_send_stat allocation failure')
allocate(e3d_tr2_recv_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr2_recv_rqst allocation failure')
allocate(e3d_tr2_recv_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr2_recv_stat allocation failure')
allocate(e3d_tr2_send_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr2_send_type allocation failure')
allocate(e3d_tr2_recv_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_tr2_recv_type allocation failure')
do i=1,nnbr
blen_send(:)=nvrt*ntracers
dspl_send(1:mnesend)=(iesend(:,i)-1)*nvrt*ntracers
#if MPIVERSION==1
call mpi_type_indexed(nesend(i),blen_send,dspl_send,rtype,e3d_tr2_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nesend(i),nvrt*ntracers,dspl_send,rtype,e3d_tr2_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e3d_tr2_send_type',ierr)
call mpi_type_commit(e3d_tr2_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e3d_tr2_send_type',ierr)
blen_recv(:)=nvrt*ntracers
dspl_recv(1:mnerecv)=(ierecv(:,i)-1)*nvrt*ntracers
#if MPIVERSION==1
call mpi_type_indexed(nerecv(i),blen_recv,dspl_recv,rtype,e3d_tr2_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nerecv(i),nvrt*ntracers,dspl_recv,rtype,e3d_tr2_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e3d_tr2_recv_type',ierr)
call mpi_type_commit(e3d_tr2_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e3d_tr2_recv_type',ierr)
enddo
allocate(e3d_2_send_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_2_send_rqst allocation failure')
allocate(e3d_2_send_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_2_send_stat allocation failure')
allocate(e3d_2_recv_rqst(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_2_recv_rqst allocation failure')
allocate(e3d_2_recv_stat(MPI_STATUS_SIZE,nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_2_recv_stat allocation failure')
allocate(e3d_2_send_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_2_send_type allocation failure')
allocate(e3d_2_recv_type(nnbr),stat=stat)
if(stat/=0) call parallel_abort('msgp_init: e3d_2_recv_type allocation failure')
do i=1,nnbr
blen_send(:)=nvrt*2
dspl_send(1:mnesend)=(iesend(:,i)-1)*nvrt*2
#if MPIVERSION==1
call mpi_type_indexed(nesend(i),blen_send,dspl_send,rtype,e3d_2_send_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nesend(i),nvrt*2,dspl_send,rtype,e3d_2_send_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e3d_2_send_type',ierr)
call mpi_type_commit(e3d_2_send_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e3d_2_send_type',ierr)
blen_recv(:)=nvrt*2
dspl_recv(1:mnerecv)=(ierecv(:,i)-1)*nvrt*2
#if MPIVERSION==1
call mpi_type_indexed(nerecv(i),blen_recv,dspl_recv,rtype,e3d_2_recv_type(i),ierr)
#elif MPIVERSION==2
call mpi_type_create_indexed_block(nerecv(i),nvrt*2,dspl_recv,rtype,e3d_2_recv_type(i),ierr)
#endif
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: create e3d_2_recv_type',ierr)
call mpi_type_commit(e3d_2_recv_type(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('msgp_init: commit e3d_2_recv_type',ierr)
enddo
deallocate(blen_send)
deallocate(blen_recv)
deallocate(dspl_send)
deallocate(dspl_recv)
end subroutine msgp_init
subroutine exchange_e2d(e2d_data)
implicit none
real(rkind),intent(inout) :: e2d_data(:)
integer :: i
if(nproc==1) return
do i=1,nnbr
call mpi_irecv(e2d_data,1,e2drecv_type(i),nbrrank(i),10,comm,e2drecv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e2d: irecv tag=10',ierr)
enddo
do i=1,nnbr
call mpi_isend(e2d_data,1,e2dsend_type(i),nbrrank(i),10,comm,e2dsend_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e2d: isend tag=10',ierr)
enddo
call mpi_waitall(nnbr,e2drecv_rqst,e2drecv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e2d: waitall recv',ierr)
call mpi_waitall(nnbr,e2dsend_rqst,e2dsend_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e2d: waitall send',ierr)
end subroutine exchange_e2d
subroutine exchange_e2di(e2di_data)
implicit none
integer,intent(inout) :: e2di_data(:)
integer :: i
if(nproc==1) return
do i=1,nnbr
call mpi_irecv(e2di_data,1,e2direcv_type(i),nbrrank(i),41,comm,e2direcv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e2di: irecv tag=41',ierr)
enddo
do i=1,nnbr
call mpi_isend(e2di_data,1,e2disend_type(i),nbrrank(i),41,comm,e2disend_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e2di: isend tag=41',ierr)
enddo
call mpi_waitall(nnbr,e2direcv_rqst,e2direcv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e2di: waitall recv',ierr)
call mpi_waitall(nnbr,e2disend_rqst,e2disend_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e2di: waitall send',ierr)
end subroutine exchange_e2di
subroutine exchange_e3dw(e3dw_data)
implicit none
real(rkind),intent(inout) :: e3dw_data(:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr
call mpi_irecv(e3dw_data,1,e3dwrecv_type(i),nbrrank(i),11,comm,e3dwrecv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3dw: irecv tag=11',ierr)
enddo
do i=1,nnbr
call mpi_isend(e3dw_data,1,e3dwsend_type(i),nbrrank(i),11,comm,e3dwsend_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3dw: isend tag=11',ierr)
enddo
call mpi_waitall(nnbr,e3dwrecv_rqst,e3dwrecv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3dw: waitall recv',ierr)
call mpi_waitall(nnbr,e3dwsend_rqst,e3dwsend_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3dw: waitall send',ierr)
end subroutine exchange_e3dw
subroutine exchange_p2d(p2d_data)
implicit none
real(rkind),intent(inout) :: p2d_data(:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nprecv(i)/=0) then
call mpi_irecv(p2d_data,1,p2drecv_type(i),nbrrank_p(i),20,comm,p2drecv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2d: irecv tag=20',ierr)
else
p2drecv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(npsend(i)/=0) then
call mpi_isend(p2d_data,1,p2dsend_type(i),nbrrank_p(i),20,comm,p2dsend_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2d: isend tag=20',ierr)
else
p2dsend_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,p2drecv_rqst,p2drecv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2d: waitall recv',ierr)
call mpi_waitall(nnbr_p,p2dsend_rqst,p2dsend_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2d: waitall send',ierr)
end subroutine exchange_p2d
subroutine exchange_p3dw(p3dw_data)
implicit none
real(rkind),intent(inout) :: p3dw_data(:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nprecv(i)/=0) then
call mpi_irecv(p3dw_data,1,p3dwrecv_type(i),nbrrank_p(i),21,comm,p3dwrecv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3dw: irecv tag=21',ierr)
else
p3dwrecv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(npsend(i)/=0) then
call mpi_isend(p3dw_data,1,p3dwsend_type(i),nbrrank_p(i),21,comm,p3dwsend_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3dw: isend tag=21',ierr)
else
p3dwsend_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,p3dwrecv_rqst,p3dwrecv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3dw: waitall recv',ierr)
call mpi_waitall(nnbr_p,p3dwsend_rqst,p3dwsend_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3dw: waitall send',ierr)
end subroutine exchange_p3dw
subroutine exchange_p2d_9(p2d_9_data)
implicit none
real(rkind),intent(inout) :: p2d_9_data(:,:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nprecv(i)/=0) then
call mpi_irecv(p2d_9_data,1,p2d_9_recv_type(i),nbrrank_p(i),22,comm,p2d_9_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2d_9: irecv tag=22',ierr)
else
p2d_9_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(npsend(i)/=0) then
call mpi_isend(p2d_9_data,1,p2d_9_send_type(i),nbrrank_p(i),22,comm,p2d_9_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2d_9: isend tag=22',ierr)
else
p2d_9_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,p2d_9_recv_rqst,p2d_9_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2d_9: waitall recv',ierr)
call mpi_waitall(nnbr_p,p2d_9_send_rqst,p2d_9_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2d_9: waitall send',ierr)
end subroutine exchange_p2d_9
subroutine exchange_p2di(p2di_data)
implicit none
integer,intent(inout) :: p2di_data(:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nprecv(i)/=0) then
call mpi_irecv(p2di_data,1,p2direcv_type(i),nbrrank_p(i),23,comm,p2direcv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2di: irecv tag=23',ierr)
else
p2direcv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(npsend(i)/=0) then
call mpi_isend(p2di_data,1,p2disend_type(i),nbrrank_p(i),23,comm,p2disend_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2di: isend tag=23',ierr)
else
p2disend_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,p2direcv_rqst,p2direcv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2di: waitall recv',ierr)
call mpi_waitall(nnbr_p,p2disend_rqst,p2disend_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p2di: waitall send',ierr)
end subroutine exchange_p2di
subroutine exchange_s2d(s2d_data)
implicit none
real(rkind),intent(inout) :: s2d_data(:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nsrecv(i)/=0) then
call mpi_irecv(s2d_data,1,s2drecv_type(i),nbrrank_p(i),30,comm,s2drecv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2d: irecv tag=30',ierr)
else
s2drecv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nssend(i)/=0) then
call mpi_isend(s2d_data,1,s2dsend_type(i),nbrrank_p(i),30,comm,s2dsend_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2d: isend tag=30',ierr)
else
s2dsend_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,s2drecv_rqst,s2drecv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2d: waitall recv',ierr)
call mpi_waitall(nnbr_p,s2dsend_rqst,s2dsend_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2d: waitall send',ierr)
end subroutine exchange_s2d
subroutine exchange_s2d_9(s2d_9_data)
implicit none
real(rkind),intent(inout) :: s2d_9_data(:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nsrecv(i)/=0) then
call mpi_irecv(s2d_9_data,1,s2d_9_recv_type(i),nbrrank_p(i),37,comm,s2d_9_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2d_9: irecv tag=37',ierr)
else
s2d_9_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nssend(i)/=0) then
call mpi_isend(s2d_9_data,1,s2d_9_send_type(i),nbrrank_p(i),37,comm,s2d_9_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2d_9: isend tag=37',ierr)
else
s2d_9_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,s2d_9_recv_rqst,s2d_9_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2d_9: waitall recv',ierr)
call mpi_waitall(nnbr_p,s2d_9_send_rqst,s2d_9_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2d_9: waitall send',ierr)
end subroutine exchange_s2d_9
subroutine exchange_s2di(s2di_data)
implicit none
integer,intent(inout) :: s2di_data(:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nsrecv(i)/=0) then
call mpi_irecv(s2di_data,1,s2direcv_type(i),nbrrank_p(i),35,comm,s2direcv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2di: irecv tag=35',ierr)
else
s2direcv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nssend(i)/=0) then
call mpi_isend(s2di_data,1,s2disend_type(i),nbrrank_p(i),35,comm,s2disend_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2di: isend tag=35',ierr)
else
s2disend_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,s2direcv_rqst,s2direcv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2di: waitall recv',ierr)
call mpi_waitall(nnbr_p,s2disend_rqst,s2disend_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s2di: waitall send',ierr)
end subroutine exchange_s2di
subroutine exchange_s3dw(s3dw_data)
implicit none
real(rkind),intent(inout) :: s3dw_data(:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nsrecv(i)/=0) then
call mpi_irecv(s3dw_data,1,s3dwrecv_type(i),nbrrank_p(i),31,comm,s3dwrecv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3dw: irecv tag=31',ierr)
else
s3dwrecv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nssend(i)/=0) then
call mpi_isend(s3dw_data,1,s3dwsend_type(i),nbrrank_p(i),31,comm,s3dwsend_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3dw: isend tag=31',ierr)
else
s3dwsend_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,s3dwrecv_rqst,s3dwrecv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3dw: waitall recv',ierr)
call mpi_waitall(nnbr_p,s3dwsend_rqst,s3dwsend_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3dw: waitall send',ierr)
end subroutine exchange_s3dw
subroutine exchange_s3d_5(s3d_5_data)
implicit none
real(rkind),intent(inout) :: s3d_5_data(:,:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nsrecv(i)/=0) then
call mpi_irecv(s3d_5_data,1,s3d_5_recv_type(i),nbrrank_p(i),40,comm,s3d_5_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_5: irecv tag=32',ierr)
else
s3d_5_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nssend(i)/=0) then
call mpi_isend(s3d_5_data,1,s3d_5_send_type(i),nbrrank_p(i),40,comm,s3d_5_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_5: isend tag=32',ierr)
else
s3d_5_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,s3d_5_recv_rqst,s3d_5_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_5: waitall recv',ierr)
call mpi_waitall(nnbr_p,s3d_5_send_rqst,s3d_5_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_5: waitall send',ierr)
end subroutine exchange_s3d_5
subroutine exchange_s3d_4(s3d_4_data)
implicit none
real(rkind),intent(inout) :: s3d_4_data(:,:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nsrecv(i)/=0) then
call mpi_irecv(s3d_4_data,1,s3d_4_recv_type(i),nbrrank_p(i),32,comm,s3d_4_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_4: irecv tag=32',ierr)
else
s3d_4_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nssend(i)/=0) then
call mpi_isend(s3d_4_data,1,s3d_4_send_type(i),nbrrank_p(i),32,comm,s3d_4_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_4: isend tag=32',ierr)
else
s3d_4_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,s3d_4_recv_rqst,s3d_4_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_4: waitall recv',ierr)
call mpi_waitall(nnbr_p,s3d_4_send_rqst,s3d_4_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_4: waitall send',ierr)
end subroutine exchange_s3d_4
subroutine exchange_s3d_2(s3d_2_data)
implicit none
real(rkind),intent(inout) :: s3d_2_data(:,:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nsrecv(i)/=0) then
call mpi_irecv(s3d_2_data,1,s3d_2_recv_type(i),nbrrank_p(i),33,comm,s3d_2_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_2: irecv tag=33',ierr)
else
s3d_2_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nssend(i)/=0) then
call mpi_isend(s3d_2_data,1,s3d_2_send_type(i),nbrrank_p(i),33,comm,s3d_2_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_2: isend tag=33',ierr)
else
s3d_2_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,s3d_2_recv_rqst,s3d_2_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_2: waitall recv',ierr)
call mpi_waitall(nnbr_p,s3d_2_send_rqst,s3d_2_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_2: waitall send',ierr)
end subroutine exchange_s3d_2
subroutine exchange_s3d_tr2(s3d_tr2_data)
implicit none
real(rkind),intent(inout) :: s3d_tr2_data(:,:,:)
integer :: i
if(nproc==1.or.ntracers<=0) return
do i=1,nnbr_p
if(nsrecv(i)/=0) then
call mpi_irecv(s3d_tr2_data,1,s3d_tr2_recv_type(i),nbrrank_p(i),34,comm,s3d_tr2_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_tr2: irecv tag=34',ierr)
else
s3d_tr2_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(nssend(i)/=0) then
call mpi_isend(s3d_tr2_data,1,s3d_tr2_send_type(i),nbrrank_p(i),34,comm,s3d_tr2_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_tr2: isend tag=34',ierr)
else
s3d_tr2_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,s3d_tr2_recv_rqst,s3d_tr2_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_tr2: waitall recv',ierr)
call mpi_waitall(nnbr_p,s3d_tr2_send_rqst,s3d_tr2_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_s3d_tr2: waitall send',ierr)
end subroutine exchange_s3d_tr2
subroutine exchange_p3d_2(p3d_2_data)
implicit none
real(rkind),intent(inout) :: p3d_2_data(:,:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nprecv(i)/=0) then
call mpi_irecv(p3d_2_data,1,p3d_2_recv_type(i),nbrrank_p(i),24,comm,p3d_2_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_2: irecv tag=24',ierr)
else
p3d_2_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(npsend(i)/=0) then
call mpi_isend(p3d_2_data,1,p3d_2_send_type(i),nbrrank_p(i),24,comm,p3d_2_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_2: isend tag=24',ierr)
else
p3d_2_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,p3d_2_recv_rqst,p3d_2_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_2: waitall recv',ierr)
call mpi_waitall(nnbr_p,p3d_2_send_rqst,p3d_2_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_2: waitall send',ierr)
end subroutine exchange_p3d_2
subroutine exchange_p3d_3(p3d_3_data)
implicit none
real(rkind),intent(inout) :: p3d_3_data(:,:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nprecv(i)/=0) then
call mpi_irecv(p3d_3_data,1,p3d_3_recv_type(i),nbrrank_p(i),26,comm,p3d_3_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_3: irecv tag=26',ierr)
else
p3d_3_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(npsend(i)/=0) then
call mpi_isend(p3d_3_data,1,p3d_3_send_type(i),nbrrank_p(i),26,comm,p3d_3_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_3: isend tag=26',ierr)
else
p3d_3_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,p3d_3_recv_rqst,p3d_3_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_3: waitall recv',ierr)
call mpi_waitall(nnbr_p,p3d_3_send_rqst,p3d_3_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_3: waitall send',ierr)
end subroutine exchange_p3d_3
subroutine exchange_p3d_4(p3d_4_data)
implicit none
real(rkind),intent(inout) :: p3d_4_data(:,:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr_p
if(nprecv(i)/=0) then
call mpi_irecv(p3d_4_data,1,p3d_4_recv_type(i),nbrrank_p(i),27,comm,p3d_4_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_4: irecv tag=27',ierr)
else
p3d_4_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(npsend(i)/=0) then
call mpi_isend(p3d_4_data,1,p3d_4_send_type(i),nbrrank_p(i),27,comm,p3d_4_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_4: isend tag=27',ierr)
else
p3d_4_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,p3d_4_recv_rqst,p3d_4_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_4: waitall recv',ierr)
call mpi_waitall(nnbr_p,p3d_4_send_rqst,p3d_4_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_4: waitall send',ierr)
end subroutine exchange_p3d_4
subroutine exchange_p3d_tr(p3d_tr_data)
implicit none
real(rkind),intent(inout) :: p3d_tr_data(:,:,:)
integer :: i
if(nproc==1.or.ntracers<=0) return
do i=1,nnbr_p
if(nprecv(i)/=0) then
call mpi_irecv(p3d_tr_data,1,p3d_tr_recv_type(i),nbrrank_p(i),25,comm,p3d_tr_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_tr: irecv tag=25',ierr)
else
p3d_tr_recv_rqst(i)=MPI_REQUEST_NULL
endif
enddo
do i=1,nnbr_p
if(npsend(i)/=0) then
call mpi_isend(p3d_tr_data,1,p3d_tr_send_type(i),nbrrank_p(i),25,comm,p3d_tr_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_tr: isend tag=25',ierr)
else
p3d_tr_send_rqst(i)=MPI_REQUEST_NULL
endif
enddo
call mpi_waitall(nnbr_p,p3d_tr_recv_rqst,p3d_tr_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_tr: waitall recv',ierr)
call mpi_waitall(nnbr_p,p3d_tr_send_rqst,p3d_tr_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_p3d_tr: waitall send',ierr)
end subroutine exchange_p3d_tr
subroutine exchange_e3d_tr(e3d_tr_data)
implicit none
real(rkind),intent(inout) :: e3d_tr_data(:,:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr
call mpi_irecv(e3d_tr_data,1,e3d_tr_recv_type(i),nbrrank(i),12,comm,e3d_tr_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_tr: irecv tag=12',ierr)
enddo
do i=1,nnbr
call mpi_isend(e3d_tr_data,1,e3d_tr_send_type(i),nbrrank(i),12,comm,e3d_tr_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_tr: isend tag=12',ierr)
enddo
call mpi_waitall(nnbr,e3d_tr_recv_rqst,e3d_tr_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_tr: waitall recv',ierr)
call mpi_waitall(nnbr,e3d_tr_send_rqst,e3d_tr_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_tr: waitall send',ierr)
end subroutine exchange_e3d_tr
subroutine exchange_e3d_tr2(e3d_tr2_data)
implicit none
real(rkind),intent(inout) :: e3d_tr2_data(:,:,:)
integer :: i
if(nproc==1.or.ntracers<=0) return
do i=1,nnbr
call mpi_irecv(e3d_tr2_data,1,e3d_tr2_recv_type(i),nbrrank(i),14,comm,e3d_tr2_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_tr2: irecv tag=14',ierr)
enddo
do i=1,nnbr
call mpi_isend(e3d_tr2_data,1,e3d_tr2_send_type(i),nbrrank(i),14,comm,e3d_tr2_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_tr2: isend tag=14',ierr)
enddo
call mpi_waitall(nnbr,e3d_tr2_recv_rqst,e3d_tr2_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_tr2: waitall recv',ierr)
call mpi_waitall(nnbr,e3d_tr2_send_rqst,e3d_tr2_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_tr2: waitall send',ierr)
end subroutine exchange_e3d_tr2
subroutine exchange_e3d_2(e3d_2_data)
implicit none
real(rkind),intent(inout) :: e3d_2_data(:,:,:)
integer :: i
if(nproc==1) return
do i=1,nnbr
call mpi_irecv(e3d_2_data,1,e3d_2_recv_type(i),nbrrank(i),13,comm,e3d_2_recv_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_2: irecv tag=13',ierr)
enddo
do i=1,nnbr
call mpi_isend(e3d_2_data,1,e3d_2_send_type(i),nbrrank(i),13,comm,e3d_2_send_rqst(i),ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_2: isend tag=13',ierr)
enddo
call mpi_waitall(nnbr,e3d_2_recv_rqst,e3d_2_recv_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_2: waitall recv',ierr)
call mpi_waitall(nnbr,e3d_2_send_rqst,e3d_2_send_stat,ierr)
if(ierr/=MPI_SUCCESS) call parallel_abort('exchange_e3d_2: waitall send',ierr)
end subroutine exchange_e3d_2
end module elfe_msgp
